blueprint:
  name: Recargar Integraciones Autom谩ticamente (v1.0.0)
  description: >-
    # Recargar Integraciones Autom谩ticamente (v1.0.0)

    ** Automatizaci贸n para recargar integraciones que se quedan "colgadas" en Home Assistant**


    Este blueprint monitoriza las entidades seleccionadas y cuando detecta que se quedan en estado 
    "No disponible", autom谩ticamente intenta recargar la integraci贸n correspondiente. Si despu茅s 
    de varios intentos la integraci贸n sigue sin funcionar, te enviar谩 una notificaci贸n para que 
    sepas que necesita atenci贸n manual.


    ** Casos de uso t铆picos:**

    - Integraci贸n de AEMET que se desconecta

    - Dispositivos Xiaomi/Roborock que pierden conexi贸n

    - APIs externas que fallan temporalmente

    - Sensores Wi-Fi que se desconectan

    - ...


    ** [驴Tienes dudas?](https://domoticarte.com/p/recargar-integraciones-blueprint)**
  domain: automation
  author: danimart1991 (https://github.com/danimart1991)
  homeassistant:
    min_version: 2024.6.0

  input:
    general:
      name: Configuraci贸n General
      icon: mdi:tune
      description: Configuraci贸nes principales de la automatizaci贸n
      collapsed: false
      input:
        entities:
          name: Entidades a monitorizar
          description: >-
            Selecciona las entidades que quieres monitorizar. Cuando una de estas entidades 
            se quede en estado "No disponible", la automatizaci贸n intentar谩 recargar su integraci贸n.


            ** Ejemplos de entidades t铆picas:**

            - `weather.aemet` (para la integraci贸n de AEMET).

            - `vacuum.roborock_s5_max` (para robots aspirador Roborock/Xiaomi).

            - `sensor.samsung_1234` (para dispositivos Samsung SmartThings).

            - `switch.tapo_c210_privacy` (para c谩maras Tapo).
          selector:
            entity:
              multiple: true
        check_duration:
          name: Tiempo antes del primer intento y entre reintentos
          description: >-
            Tiempo que debe estar una entidad "No disponible" antes de intentar recargar 
            la integraci贸n, y tiempo de espera entre cada reintento.


            ** Valores recomendados:**

            - **5 minutos**: Para integraciones estables (AEMET, Roborock, etc.).

            - **2 minutos**: Para dispositivos que se desconectan frecuentemente.

            - **10 minutos**: Para integraciones que tardan en responder.
          selector:
            duration:
          default:
            hours: 0
            minutes: 5
            seconds: 0
        tries:
          name: N煤mero m谩ximo de intentos
          description: >-
            Cu谩ntas veces intentar谩 recargar la integraci贸n antes de darse por vencida 
            y enviar la notificaci贸n de error.


            ** Valores t铆picos:**

            - **3 intentos**: Para integraciones estables.

            - **5 intentos**: Para integraciones problem谩ticas (valor recomendado).

            - **10 intentos**: Para casos muy problem谩ticos.
          default: 5
          selector:
            number:
              min: 1
              max: 20
              step: 1
    notifications:
      name: Configuraci贸n de Notificaciones/Acciones
      icon: mdi:bell
      description: Configuraci贸n para las notificaciones/acciones cuando no se puede recargar una integraci贸n
      collapsed: false
      input:
        not_working_actions:
          name: Acciones cuando falla la recuperaci贸n
          description: >-
            Acciones que se ejecutar谩n cuando la automatizaci贸n no consiga recargar la integraci贸n 
            despu茅s de todos los intentos. T铆picamente enviar una notificaci贸n al m贸vil.


            ** Variables disponibles para usar en las acciones/notificaciones:**

            - `{{ trigger.entity_id }}` - ID de la entidad que fall贸.

            - `{{ trigger.from_state.attributes.friendly_name }}` - Nombre amigable de la entidad.

            - `{{ area_name(trigger.entity_id) }}` - rea donde est谩 la entidad (si est谩 asignada).


            ** Ejemplo de mensaje:**
            "La integraci贸n {{ trigger.from_state.attributes.friendly_name }} sigue sin funcionar tras varios intentos"
          selector:
            action: {}
          default:
            - action: notify.notify
              data:
                title: " Error Recargando Integraci贸n"
                message: >-
                  La entidad {{ trigger.from_state.attributes.friendly_name }}
                  ({{ trigger.entity_id }}) sigue sin funcionar despu茅s de varios
                  intentos de recarga autom谩ticos. Revisa manualmente la integraci贸n.

mode: parallel
max: 10

triggers:
  - trigger: state
    entity_id: !input entities
    to: unavailable
    for: !input check_duration

conditions: []

actions:
  - repeat:
      count: !input tries
      sequence:
        - action: homeassistant.reload_config_entry
          data: {}
          target:
            entity_id: "{{ trigger.entity_id }}"
        - delay: !input check_duration
        - if:
            - condition: template
              value_template: "{{ states(trigger.entity_id) == 'unavailable' }}"
          then: []
          else:
            - stop: ""
  - choose: []
    default: !input not_working_actions
